<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.20">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Code Eat Code RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Code Eat Code Atom Feed"><title data-rh="true">Journey To The Centre Of The Stack | Code Eat Code</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://codeeatcode.github.io/journey-to-the-centre-of-the-stack/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Journey To The Centre Of The Stack | Code Eat Code"><meta data-rh="true" name="description" content="Journey to the Centre of the stack - Dockerising the legacy"><meta data-rh="true" property="og:description" content="Journey to the Centre of the stack - Dockerising the legacy"><meta data-rh="true" name="keywords" content="docker,legacy-software,modernisation,containesization,containezization"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2020-11-30T11:00:00.000Z"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://codeeatcode.github.io/journey-to-the-centre-of-the-stack/"><link data-rh="true" rel="alternate" href="https://codeeatcode.github.io/journey-to-the-centre-of-the-stack/" hreflang="en"><link data-rh="true" rel="alternate" href="https://codeeatcode.github.io/journey-to-the-centre-of-the-stack/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.12ad74ea.css">
<link rel="preload" href="/assets/js/runtime~main.56d46964.js" as="script">
<link rel="preload" href="/assets/js/main.9c2ccf34.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Code Eat Ccode" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="Code Eat Ccode" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title text--truncate">Code Eat Code</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">GitHub</a><ul class="dropdown__menu"><li><a href="https://github.com/ambersariya" target="_blank" rel="noopener noreferrer" class="dropdown__link">GitHub Personal<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/codeeatcode" target="_blank" rel="noopener noreferrer" class="dropdown__link">GitHub Org<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_dLyj"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_TMXw thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_V4zb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_uHd5 clean-list"><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/establishing-a-walking-skeleton-for-projects/">Establishing A Walking Skeleton For Projects</a></li><li class="sidebarItem_spIe"><a aria-current="page" class="sidebarItemLink_eqrF sidebarItemLinkActive_XZSJ" href="/journey-to-the-centre-of-the-stack/">Journey To The Centre Of The Stack</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/JSON-WEB-TOKEN/">JSON Web Tokens</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/blogging-like-a-hacker/">Blogging Like a Hacker</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">Journey To The Centre Of The Stack</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-11-30T11:00:00.000Z" itemprop="datePublished">November 30, 2020</time> · <!-- -->6 min read</div></header><div id="post-content" class="markdown" itemprop="articleBody"><h4 class="anchor anchorWithStickyNavbar_mojV" id="dockerising-the-legacy">Dockerising the legacy<a class="hash-link" href="#dockerising-the-legacy" title="Direct link to heading">​</a></h4><p>Making changes to application infrastructure can be daunting at the best of times so when it was decided that we move to the world of containers, I took on a task I didn’t know the depth of, so I am going to share my experience of getting my hands dirty.</p><p>At the time, I was new to docker but very interested in the technology, as technology folks, we all love a shiny new toy to play with. Apart from that the advantages and thus the reasons for so are listed as follows in no particular order:</p><ul><li>Introducing speedier changes and testing ideas faster</li><li>Infrastructure as code</li><li>Simplify application/tech stack</li><li>Be cloud-friendly</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="legacy-stack">Legacy Stack<a class="hash-link" href="#legacy-stack" title="Direct link to heading">​</a></h2><p>Where working with the difficulty of releasing changes in the current environment that are potentially outdated, have no tests and no real dependency management, installing the dependencies and developing newer features can be a considerable effort.</p><p>The monster you could be working with may consist of the spaghetti of many applications running outdated technology.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="doing-the-dirty-work">Doing the dirty work<a class="hash-link" href="#doing-the-dirty-work" title="Direct link to heading">​</a></h2><p>I would, of course, start with looking at the stack diagram of sorts or create one if there’s isn’t one already and identify common things between the applications. If you have more than one application that shares a lot of common things such as language, set of libraries, webserver and OS, then extract this to a base image that each application can build on and extend.</p><p>For example, what tripped me when I tested one of the apps where file upload functionality failed because the file size was larger than the one allowed. So take care to look through configs of environments &amp; language etc.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="environment-variables">Environment Variables<a class="hash-link" href="#environment-variables" title="Direct link to heading">​</a></h2><p>These will be your friend when dockerising an application so I would identify various things such as follows</p><ul><li>File storage paths e.g. for static assets</li><li>URLs</li><li>Secrets</li></ul><p>Furthermore, environment variables helped me greatly in maintaining compatibility via feature flags as I wanted to maintain compatibility between the current environment and the potential new docker environment.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="file-paths">File paths<a class="hash-link" href="#file-paths" title="Direct link to heading">​</a></h2><p>Extract these paths across the applications and move to constants or move them to environment variables. So if you have a path dependency on e.g. <strong><em>/tmp</em></strong> this could be moved to an environment variable named <strong>TMP_PATH,</strong> making it configurable which can be supplied when the container is run.</p><p>In reality, you’ll likely be running multiple instances of the same container so changing this in favour of persistent storage via Kubernetes or Docker volumes would be better to allow access to any stored files to any multiple running instances. If you have the option, move files to S3 buckets or similar e.g. Min.io.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="extract-secrets">Extract secrets<a class="hash-link" href="#extract-secrets" title="Direct link to heading">​</a></h2><p>Extract any secrets e.g. API Keys to Docker/Kubernetes secrets, these could be stored in your favourite secrets management solution. Although initially, you may not have an established secrets management solution, so moving these to environment variables temporarily would allow you to get on with the job at hand.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="logging-mechanism">Logging mechanism<a class="hash-link" href="#logging-mechanism" title="Direct link to heading">​</a></h2><p>If you’re dockerising a legacy application then you’ll likely more than one process doing some important work e.g. Apache/Nginx logs, application logs, cron logs. These may also be writing to multiple different log files.</p><p>In suggested practice, it’s best to write to the standard output stream to see a combined view although you’ll want to differentiate between logs of different kinds. This can be done with a centralised logging solution for later.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="language-versions">Language versions<a class="hash-link" href="#language-versions" title="Direct link to heading">​</a></h2><p>This applies to any language but picking a ready-built official Docker image will go a long way to simplifying your life. Failing that, if nothing is available then look to build the language from the source on the closest os version. It should minimise any compatibility differences.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="web-server">Web Server<a class="hash-link" href="#web-server" title="Direct link to heading">​</a></h2><p>Keep to the same web server and the same version where possible.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="session-storage-paths">Session storage paths<a class="hash-link" href="#session-storage-paths" title="Direct link to heading">​</a></h2><p>Try to opt for a unified storage for sessions for example Database backed sessions otherwise try to go for a unified file path using persistent storage mounts.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="access-to-other-web-services">Access to other web services<a class="hash-link" href="#access-to-other-web-services" title="Direct link to heading">​</a></h2><p>Be mindful of how your application talks to another in your network. Whether this is via DNS or by hardcoded IP, you’ll want to change this to access this service by service name. The address should be extracted to an environment variable also to allow for configuration.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="how-to-test-changes-as-you-refactor">How to test changes as you refactor?<a class="hash-link" href="#how-to-test-changes-as-you-refactor" title="Direct link to heading">​</a></h2><p>If you’re lucky enough to have various types of tests for your application then keep running tests every so often while you make changes. Either run these locally or if you have a CI server setup to build your image and test on every push then that’s great.</p><p>Failing that, test the area/feature you’re refactoring by running the application with some dummy data.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="reverse-proxying">Reverse Proxying<a class="hash-link" href="#reverse-proxying" title="Direct link to heading">​</a></h2><p>Use a reverse proxy such as Nginx/HA Proxy/Traefik to act as an ingress controller for requests.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="ssl-termination">SSL Termination<a class="hash-link" href="#ssl-termination" title="Direct link to heading">​</a></h2><p>Important to figure this one when you consider yourself done with Dockerisation, as this may not be your biggest problem initially where you run one container in isolation.</p><p>One gotcha with this will be when, say, you go to production where your ingress is using a reverse proxy or a load balancer then if your application sets secure cookies, they may not be transmitted to the browser to be stored if you’re not using SSL with your app.</p><p><img loading="lazy" src="https://www.nginx.com/wp-content/uploads/2014/04/nginx-decrypts-https-traffic.png" alt="SSL Termination Nginx" class="img_E7b_"></p><p>Shamelessly borrowed from <a href="https://www.nginx.com/blog/nginx-ssl/" target="_blank" rel="noopener noreferrer">https://www.nginx.com/blog/nginx-ssl/</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="cronjobs">Cronjobs<a class="hash-link" href="#cronjobs" title="Direct link to heading">​</a></h2><p>If you plan on using Kubernetes then it allows you to schedule workloads that can be scheduled using a cronjob like syntax. Please see more details here: <a href="https://www.nginx.com/blog/nginx-ssl/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="file-permissions">File permissions<a class="hash-link" href="#file-permissions" title="Direct link to heading">​</a></h2><p>Container’s file permissions get copied from the host machine’s file system while building images so be mindful when building them on environments implementing the least privilege principle on the filesystem.</p><p>So when you COPY or ADD files, you can use the following</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">COPY [--chown=&lt;user&gt;:&lt;group&gt;] &lt;src&gt;... &lt;dest&gt;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="summary">Summary<a class="hash-link" href="#summary" title="Direct link to heading">​</a></h2><p>I may have glossed over a few things but I would like to say that no matter how much I share, your own journey will give you a great bit of experience and hope I’ve shared some gotchas that may be of some help. So dive right in but with some consideration :-)</p><p>Thanks for sticking with me.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/establishing-a-walking-skeleton-for-projects/"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Establishing A Walking Skeleton For Projects</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/JSON-WEB-TOKEN/"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">JSON Web Tokens</div></a></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#legacy-stack" class="table-of-contents__link toc-highlight">Legacy Stack</a></li><li><a href="#doing-the-dirty-work" class="table-of-contents__link toc-highlight">Doing the dirty work</a></li><li><a href="#environment-variables" class="table-of-contents__link toc-highlight">Environment Variables</a></li><li><a href="#file-paths" class="table-of-contents__link toc-highlight">File paths</a></li><li><a href="#extract-secrets" class="table-of-contents__link toc-highlight">Extract secrets</a></li><li><a href="#logging-mechanism" class="table-of-contents__link toc-highlight">Logging mechanism</a></li><li><a href="#language-versions" class="table-of-contents__link toc-highlight">Language versions</a></li><li><a href="#web-server" class="table-of-contents__link toc-highlight">Web Server</a></li><li><a href="#session-storage-paths" class="table-of-contents__link toc-highlight">Session storage paths</a></li><li><a href="#access-to-other-web-services" class="table-of-contents__link toc-highlight">Access to other web services</a></li><li><a href="#how-to-test-changes-as-you-refactor" class="table-of-contents__link toc-highlight">How to test changes as you refactor?</a></li><li><a href="#reverse-proxying" class="table-of-contents__link toc-highlight">Reverse Proxying</a></li><li><a href="#ssl-termination" class="table-of-contents__link toc-highlight">SSL Termination</a></li><li><a href="#cronjobs" class="table-of-contents__link toc-highlight">Cronjobs</a></li><li><a href="#file-permissions" class="table-of-contents__link toc-highlight">File permissions</a></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Find Me</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/_ambersariya" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/danish-javed/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Code Eat Code blog built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.56d46964.js"></script>
<script src="/assets/js/main.9c2ccf34.js"></script>
</body>
</html>